---
title: "Exploring temporal signal"
date: '`r format(Sys.Date(), "%B %d %Y")`'
author: "Will Harvey"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Exploring temporal signal}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

```{r, message = FALSE}
# load the package into R
library(toolkitSeqTree)

# load other useful packages
library(ggtree)
library(ggplot2)
library(dplyr)
library(lubridate)
```

## Temporal signal in heterochronous sequences

Here, the function `tree_tempest()` is used to explore the relationship between genetic divergence through time and sampling date. The presence of temporal signal in sequences sampled through time can be used to assess whether to process with phylogenetic molecular clock analysis. 

The function `tree_tempest()` is inspired by the software tool TempEst (Rambaut, Lam, de Carvalho & Pybus, Virus Evolution, 2016, 2(1): vew007) which is available at http://tree.bio.ed.ac.uk/software/tempest/.

### Phylogeny for temporally sampled sequences

In this example uses a maximum likelihood phylogenetic tree for 87 concatenated influenza A(H5N8) genomes collected in late 2016 and throughout 2017. The labels in the tree include the sampling dates which can be extracted after using `ggtree::fortify()` to generate a data frame from the tree object.

The phylogenetic tree has been generated using raxml (https://cme.h-its.org/exelixis/web/software/raxml/).

```{r}
tree <- treeio::read.tree('../inst/extdata/h5n8_fullGenome.raxml.bestTree.tre')
tree_dat <- fortify(tree)

# extract the part of the taxon labels in the tree that contain sampling date
tree_dat$date <- ifelse(tree_dat$isTip == T,
                        stringr::str_extract(tree_dat$label, '[\\-0-9]+$'),
                        NA)
```

The extracted dates can now be used to colour tip nodes on a plot of the phylogeny.

```{r}
ggtree(tree_dat) +
  geom_tippoint(aes(fill = Date2decimal(date)), pch = 21, size = 2) +
  scale_fill_gradientn(colours = c('gold', 'forestgreen', 'dodgerblue'),
                       name = 'Date')
```

### Using `tree_tempest()`

The data frame generated by `ggtree::fortify()` can be supplied to `tree_tempest()` to explore
the relationship between sequence divergence and sampling date. The regression of root-to-tip
divergence and samling date gives an idea of the presence of temporal signal. `tree_tempest()`
returns some summary statistics associated with this regression and a scatter plot where each point represents a tip node on the phylogeny.

```{r}
tree_tempest(tree_dat)
```

### Using `tree_tempest()` with `residuals = TRUE`

```{r}
tree_tempest(tree_dat, residuals = TRUE)
```
